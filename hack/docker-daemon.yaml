apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: docker
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 200Gi
---
apiVersion: v1
kind: Service
metadata:
  name: dind
spec:
  ports:
    - port: 2375
  selector:
    app: docker-in-docker
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: docker-in-docker
spec:
  strategy:
    type: Recreate
  replicas: 1
  selector:
    matchLabels:
      app: docker-in-docker
  template:
    metadata:
      labels:
        app: docker-in-docker
    spec:
      containers:
        - name: docker
          image: docker:23.0.3-dind@sha256:a2e34bde4cb23eaef4f3d5016c78f4a7ee06b65f80d07c7ba69a1e262977a97a
          args:
            - sh
            - -c
            - dockerd
              --host=tcp://127.0.0.1:2375
              --host=tcp://${POD_IP}:2375
              --insecure-registry=10.0.0.0/8
              --insecure-registry=172.16.0.0/12
              --insecure-registry=192.168.0.0/16
              --mtu=1200
          env:
            - name: DOCKER_DRIVER
              value: overlay2
            - name: DOCKER_HOST
              value: tcp://127.0.0.1:2375
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          resources:
            requests:
              memory: "6Gi"
              cpu: "500m"
            limits:
              memory: "6Gi"
              cpu: "2000m"
          securityContext:
            privileged: true
          readinessProbe:
            exec:
              command:
                - docker
                - version
          volumeMounts:
            - mountPath: /var/lib/docker
              name: docker
      volumes:
        - name: docker
          persistentVolumeClaim:
            claimName: docker
